# WaitGroup 和监视协程详解

## 关于你的疑问：监视协程是如何工作的？

当我们看到这样的代码：

```go
go func() {
    wg.Wait()
    close(results)
}()
```

你的疑问是：这个协程看上去在实例化后就立即执行了这两行代码，怎么就起到了监视作用？

### 关键点：`wg.Wait()` 是阻塞的

这段代码的监视功能主要依赖于 `wg.Wait()` 方法的**阻塞特性**：

1. `wg.Wait()` 会阻塞当前协程（在这里是监视协程），直到 `WaitGroup` 的计数器归零
2. 计数器通过 `wg.Add(n)` 增加，通过 `wg.Done()` 减少
3. 只有当所有工作协程都调用了 `wg.Done()` 后，`wg.Wait()` 才会解除阻塞

### 执行流程详解

假设我们有5个工作协程，执行流程大致如下：

1. 主协程：创建 `wg`，初始计数为0
2. 主协程：为每个工作任务调用 `wg.Add(1)`，计数变为5
3. 主协程：启动5个工作协程
4. 主协程：启动监视协程
5. **监视协程：执行到 `wg.Wait()` 时阻塞**（关键点）
6. 工作协程1-5：各自执行任务，完成后调用 `wg.Done()`
7. 当最后一个工作协程调用 `wg.Done()` 时，计数变为0
8. **监视协程：`wg.Wait()` 解除阻塞，继续执行**
9. 监视协程：执行 `close(results)`，安全地关闭通道

### 图解流程

```
主协程              监视协程              工作协程1,2,3,4,5
  |                   |                     |  |  |  |  |
  |-- 创建WaitGroup --|                     |  |  |  |  |
  |-- wg.Add(1-5) ----|                     |  |  |  |  |
  |-- 启动工作协程 -------------------> 开始工作  |  |  |  |
  |                   |                     |  |  |  |  |
  |-- 启动监视协程 -->|                     |  |  |  |  |
  |                   |-- wg.Wait() 阻塞 ---|  |  |  |  |
  |                   |     (等待中...)     |  |  |  |  |
  |                   |                     |  |  |  |  |
  |                   |                  完成工作 |  |  |  |
  |                   |                  wg.Done()|  |  |  |
  |                   |     (等待中...)     |  |  |  |  |
  |                   |                     |  |  |  |  |
  |                   |                     | 完成并wg.Done |
  |                   |     (等待中...)     |  |  |  |  |
  |                   |                     |  |  |  |  |
  |                   |                     |  | 完成并wg.Done |
  |                   |     (等待中...)     |  |  |  |  |
  |                   |                     |  |  |  |  |
  |                   |                     |  |  | 完成并wg.Done |
  |                   |     (等待中...)     |  |  |  |  |
  |                   |                     |  |  |  |  |
  |                   |                     |  |  |  | 完成并wg.Done |
  |                   |-- wg.Wait() 返回 ---|  |  |  |  |
  |                   |-- close(results) ---|  |  |  |  |
  |                   |                     |  |  |  |  |
```

## 常见误区

1. **误区：监视协程立即执行了全部代码**
   - 实际情况：监视协程在 `wg.Wait()` 处阻塞，直到条件满足

2. **误区：需要额外逻辑来检测工作完成**
   - 实际情况：`WaitGroup` 已经提供了这种同步机制

3. **误区：`close(results)` 会立即执行**
   - 实际情况：只有在 `wg.Wait()` 解除阻塞后才会执行
